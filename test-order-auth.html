<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Authentication Test - Auric</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: window.__API_KEY__,
            authDomain: window.__PROJECT_ID__ + '.firebaseapp.com',
            projectId: window.__PROJECT_ID__,
            storageBucket: window.__PROJECT_ID__ + '.appspot.com',
            appId: window.__APP_ID__
        };

        // Try to get environment variables from meta tags
        document.addEventListener('DOMContentLoaded', function() {
            const apiKey = document.querySelector('meta[name="firebase-api-key"]')?.content;
            const projectId = document.querySelector('meta[name="firebase-project-id"]')?.content;
            const appId = document.querySelector('meta[name="firebase-app-id"]')?.content;
            
            if (apiKey && projectId && appId) {
                firebaseConfig.apiKey = apiKey;
                firebaseConfig.authDomain = projectId + '.firebaseapp.com';
                firebaseConfig.projectId = projectId;
                firebaseConfig.storageBucket = projectId + '.appspot.com';
                firebaseConfig.appId = appId;
                window.__API_KEY__ = apiKey;
                window.__PROJECT_ID__ = projectId;
                window.__APP_ID__ = appId;
            }
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            
            // Check if user is logged in
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    document.getElementById('loginStatus').textContent = 'Logged in as: ' + user.email;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userId').textContent = user.uid;
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('testOrderButton').disabled = false;
                    document.getElementById('viewOrdersButton').disabled = false;
                } else {
                    // No user is signed in
                    document.getElementById('loginStatus').textContent = 'Not logged in';
                    document.getElementById('userEmail').textContent = '-';
                    document.getElementById('userId').textContent = '-';
                    document.getElementById('loginButton').style.display = 'block';
                    document.getElementById('logoutButton').style.display = 'none';
                    document.getElementById('testOrderButton').disabled = true;
                    document.getElementById('viewOrdersButton').disabled = true;
                }
            });
        });
    </script>
    
    <!-- Custom CSS -->
    <style>
        .code-block {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-block {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Meta tags with environment variables -->
    <meta name="firebase-api-key" content="">
    <meta name="firebase-project-id" content="">
    <meta name="firebase-app-id" content="">
    
    <div class="container mt-5">
        <h1>Firebase Order Authentication Test</h1>
        
        <div class="alert alert-info mt-4">
            <p><strong>This page tests the Firebase order authentication and storage functionality.</strong></p>
            <p>Use this page to verify that orders can only be placed when a user is logged in and that they are stored correctly in the Firestore database at path: <code>users/{userId}/orders/{orderId}</code>.</p>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4>Authentication Status</h4>
            </div>
            <div class="card-body">
                <p><strong>Status:</strong> <span id="loginStatus">Checking...</span></p>
                <p><strong>User Email:</strong> <span id="userEmail">-</span></p>
                <p><strong>User ID:</strong> <span id="userId">-</span></p>
                
                <button id="loginButton" class="btn btn-primary">Log In</button>
                <button id="logoutButton" class="btn btn-outline-secondary" style="display: none;">Log Out</button>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4>Test Order Functionality</h4>
            </div>
            <div class="card-body">
                <button id="checkAuthRequirementButton" class="btn btn-info mb-3">Check Auth Requirement</button>
                <button id="testOrderButton" class="btn btn-success mb-3" disabled>Create Test Order</button>
                <button id="viewOrdersButton" class="btn btn-secondary mb-3" disabled>View User Orders</button>
                
                <div class="result-block mt-3" id="resultBlock">
                    <p class="text-muted">Results will appear here.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap Modal for Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Log In</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="loginForm" class="btn btn-primary">Log In</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS and Firebase scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // Import our Firebase order module
        import * as firebaseOrders from '/js/firebase/firebase-orders.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Login button handler
            document.getElementById('loginButton').addEventListener('click', function() {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            });
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errorElement = document.getElementById('loginError');
                
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Hide modal
                        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                        loginModal.hide();
                    })
                    .catch((error) => {
                        // Show error
                        errorElement.textContent = error.message;
                        errorElement.style.display = 'block';
                    });
            });
            
            // Logout button handler
            document.getElementById('logoutButton').addEventListener('click', function() {
                firebase.auth().signOut()
                    .then(() => {
                        console.log('User signed out');
                    })
                    .catch((error) => {
                        console.error('Error signing out:', error);
                    });
            });
            
            // Check auth requirement button
            document.getElementById('checkAuthRequirementButton').addEventListener('click', async function() {
                const resultBlock = document.getElementById('resultBlock');
                
                try {
                    const result = firebaseOrders.checkOrderAuthRequirement();
                    resultBlock.innerHTML = `
                        <h5>Auth Requirement Check Result:</h5>
                        <div class="code-block">
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                } catch (error) {
                    resultBlock.innerHTML = `
                        <h5>Error:</h5>
                        <div class="alert alert-danger">
                            ${error.message}
                        </div>
                    `;
                }
            });
            
            // Test order button
            document.getElementById('testOrderButton').addEventListener('click', async function() {
                const resultBlock = document.getElementById('resultBlock');
                resultBlock.innerHTML = `
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                try {
                    // Create a test order with mock data
                    const orderData = {
                        customer: {
                            firstName: 'Test',
                            lastName: 'User',
                            email: firebase.auth().currentUser?.email || 'test@example.com',
                            phone: '1234567890',
                            address: '123 Test Street',
                            city: 'Test City',
                            state: 'TS',
                            postalCode: '12345'
                        },
                        paymentMethod: 'card',
                        products: [
                            {
                                id: 'prod1',
                                name: 'Test Product 1',
                                price: 19.99,
                                quantity: 2,
                                total: 39.98
                            },
                            {
                                id: 'prod2',
                                name: 'Test Product 2',
                                price: 29.99,
                                quantity: 1,
                                total: 29.99
                            }
                        ],
                        orderTotal: 69.97,
                        orderReference: 'TEST-' + Date.now(),
                        orderDate: new Date().toISOString(),
                        notes: 'Test order created from the test page'
                    };
                    
                    const result = await firebaseOrders.saveOrderToFirebase(orderData);
                    
                    if (result.success) {
                        resultBlock.innerHTML = `
                            <h5>Order Created Successfully</h5>
                            <p>Order ID: <strong>${result.orderId}</strong></p>
                            <div class="code-block">
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </div>
                            <div class="alert alert-success mt-3">
                                The order has been successfully saved to Firestore at path:
                                <code>users/${firebase.auth().currentUser.uid}/orders/${result.orderId}</code>
                            </div>
                        `;
                    } else {
                        resultBlock.innerHTML = `
                            <h5>Order Creation Failed</h5>
                            <div class="code-block">
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </div>
                            ${result.requiresAuth ? `
                                <div class="alert alert-warning mt-3">
                                    Authentication is required to place an order. Please log in.
                                </div>
                            ` : `
                                <div class="alert alert-danger mt-3">
                                    Failed to create order: ${result.error}
                                </div>
                            `}
                        `;
                    }
                } catch (error) {
                    resultBlock.innerHTML = `
                        <h5>Error:</h5>
                        <div class="alert alert-danger">
                            ${error.message}
                        </div>
                    `;
                }
            });
            
            // View orders button
            document.getElementById('viewOrdersButton').addEventListener('click', async function() {
                const resultBlock = document.getElementById('resultBlock');
                resultBlock.innerHTML = `
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                try {
                    const result = await firebaseOrders.getUserOrders();
                    
                    if (result.success) {
                        if (result.orders.length > 0) {
                            let ordersHTML = '';
                            result.orders.forEach((order, index) => {
                                ordersHTML += `
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <strong>Order #${index + 1}:</strong> ${order.orderReference || order.orderId}
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Date:</strong> ${new Date(order.orderDate || order.createdAt?.toDate()).toLocaleString()}</p>
                                            <p><strong>Status:</strong> ${order.status || 'N/A'}</p>
                                            <p><strong>Total:</strong> $${order.orderTotal?.toFixed(2) || 'N/A'}</p>
                                            <p><strong>Items:</strong> ${order.products?.length || 0}</p>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            resultBlock.innerHTML = `
                                <h5>User Orders (${result.orders.length})</h5>
                                <div class="orders-list mt-3">
                                    ${ordersHTML}
                                </div>
                            `;
                        } else {
                            resultBlock.innerHTML = `
                                <h5>User Orders</h5>
                                <div class="alert alert-info mt-3">
                                    No orders found for this user.
                                </div>
                            `;
                        }
                    } else {
                        resultBlock.innerHTML = `
                            <h5>Failed to Retrieve Orders</h5>
                            <div class="code-block">
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </div>
                            ${result.requiresAuth ? `
                                <div class="alert alert-warning mt-3">
                                    Authentication is required to view orders. Please log in.
                                </div>
                            ` : `
                                <div class="alert alert-danger mt-3">
                                    Failed to retrieve orders: ${result.error}
                                </div>
                            `}
                        `;
                    }
                } catch (error) {
                    resultBlock.innerHTML = `
                        <h5>Error:</h5>
                        <div class="alert alert-danger">
                            ${error.message}
                        </div>
                    `;
                }
            });
        });
    </script>
</body>
</html>